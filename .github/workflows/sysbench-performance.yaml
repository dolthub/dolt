name: Benchmark Mini Sysbench Performance on PR

on:
  pull_request:
    paths:
      - 'go/**'
    branches: [ main ]

jobs:
  set-main-sha:
    name: Set main SHA
    runs-on: ubuntu-22.04
    outputs:
      main-sha: ${{ steps.set-vars.outputs.main-sha }}
    steps:
      - name: Set main SHA
        id: set-main
        run: |
          sha=$(git rev-parse HEAD)
          echo "version=$sha" >> $GITHUB_OUTPUT
  performance:
    name: Trigger Mini Benchmark Latency K8s Workflow
    runs-on: ubuntu-22.04
    needs: set-main-sha
    steps:
      - uses: dolthub/pull-request-comment-branch@v3
        id: comment-branch
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Get pull number
        uses: actions/github-script@v7
        id: get_pull_number
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: core.setOutput("pull_number", JSON.stringify(context.issue.number));
      - uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          event-type: benchmark-latency
          client-payload: '{"from_server": "dolt", "from_version": "${{ needs.set-main-sha.outputs.main-sha }}", "to_server": "dolt", "to_version": "${{ steps.comment-branch.outputs.head_sha }}", "mode": "pullRequest", "issue_number": "${{ steps.get_pull_number.outputs.pull_number }}", "init_big_repo": "true", "actor": "${{ github.actor }}", "sysbench_test_time": "10", "template_script": "./.github/scripts/performance-benchmarking/get-dolt-dolt-job-json.sh"}'
