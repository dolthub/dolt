#!/usr/bin/expect
source "$env(BATS_CWD)/helper/common_expect_functions.tcl"

set timeout 10
set env(NO_COLOR) 1

spawn dolt sql

expect_with_defaults {>} { send "create schema mydb;\r" }

expect_with_defaults {>} { send "use mydb;\r" }

expect_with_defaults {>} { send "call dolt_branch('branch1');\r" }

expect_with_defaults {>} { send "use \`mydb/branch1\`;\r" }

expect_with_defaults {>} { send "show databases;\r" }

expect_with_defaults_after {rows in set} {mydb/branch1\*?>} { send "use mydb;\r" }

expect_with_defaults {>} { send "use \`mydb@branch1\`;\r" }

expect_with_defaults_after {Database Changed} {mydb/branch1\*?>} { send "set @h = (select hashof('branch1') limit 1);\r" }

expect_with_defaults {>} { send "set @use_sql = concat('use `mydb@', @h, '`');\r" }

expect_with_defaults {>} { send "prepare use_stmt from @use_sql;\r" }

expect_with_defaults {>} { send "create table t1(i int);\r" }

expect_with_defaults {>} { send "call dolt_commit('-Am', 'create table t1');\r" }

expect_with_defaults {>} { send "execute use_stmt;\r" }

expect_with_defaults_after {Empty set} {mydb\*?>} { send "show tables;\r" }

expect_with_defaults_after {Empty set} {mydb\*?>} {send "set dolt_enable_revision_delimiter_alias = 0;\r" }

expect_with_defaults {>} { send "create database `mydb@branch1`;\r" }

expect_with_defaults {>} { send "use `mydb@branch1`;\r" }

expect_with_defaults_after {Database Changed} {mydb@branch1/main*?>} { send "exit;\r" }

expect eof
exit 0
