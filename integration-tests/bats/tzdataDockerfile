#syntax=docker/dockerfile:1.3
FROM golang:1.25-trixie AS smoke-binary
RUN apt-get update -y && apt-get install -y libicu-dev

# latest version that does not have timetzdata tag: https://pkg.go.dev/time/tzdata
RUN curl -L "https://github.com/dolthub/dolt/releases/download/v1.79.1/install.sh" | bash
RUN mkdir /tmp/bin/ && mv /usr/local/bin/dolt* /tmp/bin/dolt1791

# trixie is the ver. used by the release workflow
FROM golang:1.25-trixie AS source-binary
# buildindocker script expects absolute dir /src/
COPY dolt/go/go.mod /src/
WORKDIR /src/
RUN go mod download

COPY dolt/go/ .
ENV OS_ARCH_TUPLES=linux-amd64
RUN chmod +x utils/publishrelease/buildindocker.sh && utils/publishrelease/buildindocker.sh

FROM debian:bookworm-slim
RUN apt-get update -y && apt-get install -y libicu-dev && rm -rf /var/lib/apt/lists/*;
RUN rm -rf /usr/share/zoneinfo

COPY --from=smoke-binary /tmp/bin/dolt1791 /usr/local/bin/dolt1791
COPY --from=source-binary /src/out/dolt-linux-amd64/bin/dolt /usr/local/bin/dolt
RUN /usr/local/bin/dolt version

VOLUME /var/lib/dolt
EXPOSE 3306 33060 7007
WORKDIR /var/lib/dolt

