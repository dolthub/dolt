=== RUN   TestCluster
=== RUN   TestCluster/dolt_assume_cluster_role
Starting server with Config HP="0.0.0.0:3309"|T="28800000"|R="false"|L="trace"
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/controller: persisted cluster role was empty ZACHMU, apply bootstrap_role standby {}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/controller: persisted cluster role epoch is empty ZACHMU, took boostrap_epoch: 10 {}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/controller: applying commit hooks for repo1 with role standby {}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/controller: applying commit hooks for repo2 with role standby {}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/commithook: background thread: running. {role=standby, thread=Standby Replication - repo1 to standby}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/commithook: background thread: waiting for signal. {role=standby, thread=Standby Replication - repo1 to standby}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/commithook: background thread: running. {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:45-08:00 TRACE [no conn] cluster/commithook: background thread: waiting for signal. {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:45-08:00 INFO [no conn] Starting http server on :3851 {}
2022-12-11T16:11:45-08:00 WARN [no conn] error fetching http://localhost:3852/.well-known/jwks.json: Get "http://localhost:3852/.well-known/jwks.json": dial tcp 127.0.0.1:3852: connect: connection refused {component=jwks-key-provider}
2022-12-11T16:11:46-08:00 INFO [conn 1] NewConnection {DisableClientMultiStatements=false}
2022-12-11T16:11:46-08:00 DEBUG [conn 1] Starting query {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] beginning execution {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] About to call provider.DbState for repo1 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] done with call to provider.DbState for repo1 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] beginning new transaction {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] looking for transaction database repo1 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] found transaction session {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.StartTransaction {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] about to lookup db state {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] analyzed query: QueryProcess
 └─ USE(repo1)
 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] about to call RowIter {connectTime=2022-12-11T16:11:46-08:00, connectionDb=, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] committing transaction DoltTransaction {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=use repo1}
2022-12-11T16:11:46-08:00 TRACE [conn 1] returning empty result {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=use repo1}
2022-12-11T16:11:46-08:00 DEBUG [conn 1] Query finished in 1 ms {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=use repo1}
2022-12-11T16:11:46-08:00 DEBUG [conn 1] Starting query {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] beginning execution {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] beginning new transaction {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] looking for transaction database repo1 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] found transaction session {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.StartTransaction {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] about to lookup db state {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo1) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo2) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] About to call provider.DbState for repo2 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] done with call to provider.DbState for repo2 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo2) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo2) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo2) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] DoltSession.lookupDbState(repo2) {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] analyzed query: QueryProcess
 └─ CALL repo1.dolt_assume_cluster_role('standby', '9')
 {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 TRACE [conn 1] about to call RowIter {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, query=call dolt_assume_cluster_role('standby', '9')}
2022-12-11T16:11:46-08:00 WARN [conn 1] error running query {connectTime=2022-12-11T16:11:46-08:00, connectionDb=repo1, error=error assuming role 'standby' at epoch 9; already at epoch 10, query=call dolt_assume_cluster_role('standby', '9')}
    testdef.go:238: 
        	Error Trace:	/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:272
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:255
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:231
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:232
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:250
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:254
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:176
        	            				/c/Users/zachmu/liquidata/go-workspace/src/github.com/dolthub/dolt/integration-tests/go-sql-server-driver/testdef.go:178
        	Error:      	Received unexpected error:
        	            	Error 1105: error assuming role 'standby' at epoch 9; already at epoch 10
        	Test:       	TestCluster/dolt_assume_cluster_role
        	Messages:   	error running query : Error 1105: error assuming role 'standby' at epoch 9; already at epoch 10
2022-12-11T16:11:46-08:00 INFO [conn 1] ConnectionClosed {}
2022-12-11T16:11:46-08:00 INFO [no conn] http server exited. exit error: http: Server closed {}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: requested shutdown, signaling replication thread. {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: woken up. {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook replicate thread exiting; saw ctx.Err(): context canceled {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: requested shutdown, signaling replication thread. {role=standby, thread=Standby Replication - repo1 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: replicate: shutdown. {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: completed. {role=standby, thread=Standby Replication - repo2 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: woken up. {role=standby, thread=Standby Replication - repo1 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook replicate thread exiting; saw ctx.Err(): context canceled {role=standby, thread=Standby Replication - repo1 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: replicate: shutdown. {role=standby, thread=Standby Replication - repo1 to standby}
2022-12-11T16:11:46-08:00 TRACE [no conn] cluster/commithook: background thread: completed. {role=standby, thread=Standby Replication - repo1 to standby}
--- FAIL: TestCluster (0.81s)
    --- FAIL: TestCluster/dolt_assume_cluster_role (0.81s)
FAIL
FAIL	github.com/dolthub/dolt/integration-tests/go-sql-server-driver	0.819s
FAIL
